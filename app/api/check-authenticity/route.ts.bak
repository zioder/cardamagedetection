import { NextRequest, NextResponse } from 'next/server';
import { analyzeMetadata } from './lib/metadata-analyzer';
import { analyzeStatistics } from './lib/statistical-analyzer';
import { analyzeForensics } from './lib/forensics-analyzer';
import { scoreResults } from './lib/scoring-engine';
import { DetailedVerificationResult } from './types';

export async function POST(req: NextRequest) {
    console.log('[Check-Auth] Comprehensive analysis starting');
    const startTime = Date.now();

    try {
        const { image } = await req.json();
        if (!image) {
            return NextResponse.json({ error: 'No image provided' }, { status: 400 });
        }
        // @ts-ignore
        // @ts-expect-error

        const [
            metadata: any,
            statistics: any,
            forensics: any
        ] = await Promise.all([
            analyzeMetadata(image),
            analyzeStatistics(image),
            analyzeForensics(
                image,
                (metadata as any).cameraInfo?.make,
                (metadata as any).cameraInfo?.software
            ),
        ]);

        const result = scoreResults(metadata, statistics, forensics);
        result.processingTime = Date.now() - startTime;

        console.log('[Check-Auth] Analysis complete:', {
            status: result.status,
            confidence: result.confidence,
            riskScore: result.riskScore,
            processingTime: result.processingTime,
            totalFindings: result.summary.totalFindings,
        });

        return NextResponse.json(result);

    } catch (error: any) {
        console.error('[Check-Auth] Error:', error);
        return NextResponse.json(
            { error: 'System error during check', details: error.message },
            { status: 500 }
        );
    }
}
